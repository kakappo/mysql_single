# 迁移 MySQL 数据

## 方案迷思
网上搜索到的方案：

1. 搭建从库，主从同步完成后切换主从。
2. 使用 Rsync 停机迁移数据。
3. 使用 xtrabackup 停机迁移数据。

## 当前场景条件限制
原服务器使用 Docker，没有开启 GTID 和 Binlog，数据库文件大小有 113G，要求尽快将数据库迁移，最好 10 分钟以内。

由于使用了 Docker，故使用 xtrabackup 工具来做就相对麻烦了，直接 pass 掉，那就测试用 Rsync 同步效果如何吧，经过实测，全量同步需要 40 分钟左右，后续的增量同步也需要 40 分钟，有两个表的数据库文件分别是 65G 和 37G，这两个文件严重影响同步时间，所以 Rsync 方案也使用不了。

继续调研方案，发现一种流式打包上传方案，配合 pigz 压缩有奇效，方案如下：
```
磁盘读取---->打包---->压缩------>传输---->解压缩-->拆包---->落盘
           |->tar  |->gzip   |->ssh   |->gzip |->tar
```
**经过测试，同步数据只要 10 分钟左右，符合要求。**

具体使用：

1. 源主机和目的机器安装 pigz，`apt-get install pigz`。
2. 使用 `tar -c 130/data | pigz | ssh root@yourip "pigz -d | tar -xC /data/130"` 进行数据同步。

## 后续配置
1. 修改目录权限为 `mysql:mysql`。
2. 启动服务 `service mysql start`。

## 参考
[linux主机之间快速高效的拷贝大数据文件](https://lvtao.net/tool/1878.html)
